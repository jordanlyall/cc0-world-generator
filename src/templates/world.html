<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>__OG_TITLE__</title>
  <meta name="description" content="__OG_DESC__" />
  <meta property="og:title" content="__OG_TITLE__" />
  <meta property="og:description" content="__OG_DESC__" />
  <meta property="og:url" content="__OG_URL__" />
  <meta property="og:image" content="__OG_IMAGE__" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="__OG_TITLE__" />
  <meta name="twitter:description" content="__OG_DESC__" />
  <meta name="twitter:image" content="__OG_IMAGE__" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d0d0d;
      --surface: #161616;
      --surface2: #1c1c1c;
      --border: #2a2a2a;
      --text: #e8e8e8;
      --muted: #666;
      --accent: #7c3aed;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --mono: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      border-bottom: 1px solid var(--border);
      padding: 1.25rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo { font-family: var(--mono); font-size: 0.8rem; color: var(--muted); letter-spacing: 0.05em; }
    .logo span { color: var(--accent); }

    .back-link {
      font-size: 0.8rem;
      color: var(--muted);
      text-decoration: none;
    }
    .back-link:hover { color: var(--text); }

    main {
      flex: 1;
      max-width: 820px;
      margin: 0 auto;
      padding: 3rem 2rem 4rem;
      width: 100%;
    }

    /* ── Refusal state ── */
    .refusal-container {
      text-align: center;
      padding: 4rem 0;
    }

    .refusal-icon {
      font-size: 3rem;
      margin-bottom: 1.5rem;
    }

    .refusal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: #a78bfa;
    }

    .refusal-reason {
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.6;
      max-width: 480px;
      margin: 0 auto 1.5rem;
    }

    .refusal-note {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--accent);
      margin-top: 0.75rem;
    }

    /* ── World layout ── */
    .world-header { margin-bottom: 2.5rem; }

    .world-title-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .world-title {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .confidence-badge {
      font-family: var(--mono);
      font-size: 0.8rem;
      padding: 0.3rem 0.75rem;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
      margin-top: 0.4rem;
    }
    .confidence-high { background: #14532d; color: var(--green); }
    .confidence-medium { background: #422006; color: var(--yellow); }
    .confidence-low { background: #450a0a; color: var(--red); }

    .world-logline {
      font-size: 1.1rem;
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 0.5rem;
    }

    .world-prompt-tag {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: #444;
    }

    /* ── Compliance manifest (primary output) ── */
    .manifest-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .manifest-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
    }

    .manifest-label {
      font-family: var(--mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
    }

    .manifest-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
    }

    .rationale {
      font-size: 0.875rem;
      color: var(--text);
      line-height: 1.6;
      margin-bottom: 1.25rem;
    }

    .universes-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .universe-chip {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.375rem 0.75rem;
      font-size: 0.8rem;
    }

    .universe-chip-name { font-weight: 600; color: var(--text); }
    .universe-chip-meta { color: var(--muted); font-size: 0.72rem; margin-top: 0.1rem; }

    .risk-flags {
      margin-top: 1rem;
    }

    .risk-label {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin-bottom: 0.375rem;
    }

    .risk-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .risk-flag {
      font-family: var(--mono);
      font-size: 0.7rem;
      background: #2c1a00;
      color: var(--yellow);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }

    .no-flags {
      font-size: 0.78rem;
      color: var(--muted);
      font-style: italic;
    }

    /* ── World bible sections ── */
    .section {
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.09em;
      margin-bottom: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* Setting */
    .setting-block {
      font-size: 0.875rem;
      color: var(--muted);
      line-height: 1.6;
      margin-bottom: 0.75rem;
    }

    .districts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 0.5rem;
    }

    .district-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
    }

    .district-name { font-size: 0.85rem; font-weight: 600; margin-bottom: 0.25rem; }
    .district-desc { font-size: 0.78rem; color: var(--muted); line-height: 1.4; margin-bottom: 0.375rem; }
    .district-source { font-family: var(--mono); font-size: 0.67rem; color: #444; }

    /* Characters & Factions */
    .entity-list { display: flex; flex-direction: column; gap: 0.5rem; }

    .entity-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem 1rem;
      display: flex;
      gap: 0.875rem;
      align-items: flex-start;
    }

    .portrait-canvas {
      width: 52px;
      height: 52px;
      flex-shrink: 0;
      border-radius: 4px;
      overflow: hidden;
      background: #111;
    }

    .portrait-canvas svg,
    .portrait-canvas img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .entity-body { flex: 1; min-width: 0; }

    .entity-header { display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.25rem; }
    .entity-name { font-size: 0.9rem; font-weight: 600; }
    .entity-type { font-size: 0.72rem; color: var(--muted); font-family: var(--mono); }
    .entity-desc { font-size: 0.8rem; color: var(--muted); line-height: 1.45; }
    .entity-source { font-family: var(--mono); font-size: 0.67rem; color: #444; margin-top: 0.375rem; }

    /* Tone */
    .tone-tags { display: flex; flex-wrap: wrap; gap: 0.375rem; }
    .tone-tag {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 0.3rem 0.6rem;
      border-radius: 99px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    /* Relationship graph */
    .rel-list { display: flex; flex-direction: column; gap: 0.375rem; }
    .rel-row {
      font-size: 0.825rem;
      display: flex;
      align-items: baseline;
      gap: 0.375rem;
    }
    .rel-from { font-weight: 600; }
    .rel-type { color: var(--accent); font-family: var(--mono); font-size: 0.72rem; }
    .rel-to { color: var(--muted); }

    /* Visual language */
    .visual-block { font-size: 0.875rem; color: var(--muted); line-height: 1.6; }

    /* ── Share strip ── */
    .share-strip {
      border-top: 1px solid var(--border);
      padding-top: 1.5rem;
      margin-top: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .share-url {
      flex: 1;
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--muted);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.4rem 0.75rem;
      cursor: pointer;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .copy-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 0.4rem 0.875rem;
      font-size: 0.78rem;
      border-radius: 4px;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      white-space: nowrap;
    }
    .copy-btn:hover { color: var(--text); border-color: var(--accent); }

    footer {
      border-top: 1px solid var(--border);
      padding: 1.25rem 2rem;
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      gap: 1rem;
    }
    footer a { color: var(--muted); text-decoration: none; }
    footer a:hover { color: var(--text); }
  </style>
</head>
<body>

<header>
  <div class="logo"><span>CC0</span> World Generator</div>
  <a class="back-link" href="/">← Generate another</a>
</header>

<main id="main">
  <!-- Populated by JS from embedded JSON -->
  <p style="color: var(--muted); font-size: 0.875rem;">Loading world...</p>
</main>

<footer>
  <span>Five CC0 universes. Manifest-first. Corpus cap is sacred.</span>
  <a href="/">Generate another</a>
</footer>

<script>
  const WORLD = __WORLD_JSON__;

  function t(str) {
    // Safe text node creator
    return document.createTextNode(str || '');
  }

  function el(tag, attrs, ...children) {
    const node = document.createElement(tag);
    if (attrs) {
      for (const [k, v] of Object.entries(attrs)) {
        if (k === 'class') node.className = v;
        else if (k === 'style') node.style.cssText = v;
        else node.setAttribute(k, v);
      }
    }
    for (const child of children) {
      if (child == null) continue;
      node.appendChild(typeof child === 'string' ? t(child) : child);
    }
    return node;
  }

  function renderRefusal(data) {
    const r = data.refusal || {};
    return el('div', { class: 'refusal-container' },
      el('div', { class: 'refusal-icon' }, t('⛔')),
      el('h1', { class: 'refusal-title' }, t('Prompt Refused')),
      el('p', { class: 'refusal-reason' }, t(r.reason || 'This prompt falls outside the verified CC0 corpus.')),
      el('p', { class: 'refusal-note' }, t('Refusal isn\'t failure. It\'s how the system stays honest.')),
    );
  }

  function renderWorld(data) {
    const wb = data.world_bible || {};
    const cm = data.compliance_manifest || {};
    const conf = cm.commercial_confidence || 'low';
    const setting = wb.setting || {};
    const tone = wb.tone || {};

    const frag = document.createDocumentFragment();

    // ── World header ──
    const header = el('div', { class: 'world-header' });

    const titleRow = el('div', { class: 'world-title-row' });
    titleRow.appendChild(el('h1', { class: 'world-title' }, t(wb.title || data.id)));

    const badge = el('span', { class: 'confidence-badge confidence-' + conf }, t(conf));
    titleRow.appendChild(badge);
    header.appendChild(titleRow);

    if (wb.logline) header.appendChild(el('p', { class: 'world-logline' }, t(wb.logline)));
    if (data.prompt) header.appendChild(el('p', { class: 'world-prompt-tag' }, t('\u201c' + data.prompt + '\u201d')));
    frag.appendChild(header);

    // ── Compliance manifest (PRIMARY OUTPUT) ──
    const manifest = el('div', { class: 'manifest-section' });
    const mHeader = el('div', { class: 'manifest-header' });
    mHeader.appendChild(el('div', { class: 'manifest-dot' }));
    mHeader.appendChild(el('span', { class: 'manifest-label' }, t('Compliance Manifest')));
    manifest.appendChild(mHeader);

    // Rationale (field is commercial_confidence_rationale in schema)
    const rationale = cm.commercial_confidence_rationale || cm.rationale;
    if (rationale) {
      manifest.appendChild(el('p', { class: 'rationale' }, t(rationale)));
    }

    // Asset clearances — the primary manifest output
    const clearances = cm.asset_clearances || [];
    if (clearances.length > 0) {
      const grid = el('div', { class: 'universes-grid' });
      for (const c of clearances) {
        const chip = el('div', { class: 'universe-chip' });
        chip.appendChild(el('div', { class: 'universe-chip-name' }, t(c.source_universe || c.asset || '')));
        if (c.license) chip.appendChild(el('div', { class: 'universe-chip-meta' }, t(c.license)));
        if (c.risk_flags && c.risk_flags.length > 0) {
          chip.appendChild(el('div', { class: 'universe-chip-meta' }, t('⚠ ' + c.risk_flags.join(', '))));
        }
        grid.appendChild(chip);
      }
      manifest.appendChild(grid);
    }

    // Prohibited uses
    const prohibited = cm.prohibited_in_this_bible || [];
    if (prohibited.length > 0) {
      const pBlock = el('div', { style: 'margin-top:1rem;' });
      pBlock.appendChild(el('div', { class: 'risk-label' }, t('Prohibited in this Bible')));
      const pList = el('ul', { style: 'margin-top:0.375rem; padding-left:1.25rem;' });
      for (const p of prohibited) {
        pList.appendChild(el('li', { style: 'font-size:0.78rem; color:var(--muted); margin-bottom:0.25rem; line-height:1.4;' }, t(p)));
      }
      pBlock.appendChild(pList);
      manifest.appendChild(pBlock);
    }

    // Risk flags — use unsuppressed_flags (the actual field name)
    const flags = cm.unsuppressed_flags || cm.risk_flags || data.risk_flags || [];
    const rfSection = el('div', { class: 'risk-flags' });
    rfSection.appendChild(el('div', { class: 'risk-label' }, t('Risk Flags')));
    if (flags.length === 0) {
      rfSection.appendChild(el('span', { class: 'no-flags' }, t('None')));
    } else {
      const list = el('div', { class: 'risk-list' });
      for (const f of flags) {
        list.appendChild(el('span', { class: 'risk-flag' }, t(f)));
      }
      rfSection.appendChild(list);
    }
    manifest.appendChild(rfSection);
    frag.appendChild(manifest);

    // ── Tone ──
    const toneArr = Array.isArray(tone) ? tone : (tone.descriptors || tone.tags || (typeof tone === 'string' ? [tone] : []));
    if (toneArr.length > 0) {
      const s = el('div', { class: 'section' });
      s.appendChild(sectionTitle('Tone'));
      const tags = el('div', { class: 'tone-tags' });
      for (const tag of toneArr) {
        tags.appendChild(el('span', { class: 'tone-tag' }, t(tag)));
      }
      s.appendChild(tags);
      frag.appendChild(s);
    }

    // ── Setting ──
    const sSection = el('div', { class: 'section' });
    sSection.appendChild(sectionTitle('Setting'));
    if (setting.description) {
      sSection.appendChild(el('p', { class: 'setting-block' }, t(setting.description)));
    }
    const districts = setting.districts || [];
    if (districts.length > 0) {
      const grid = el('div', { class: 'districts-grid' });
      for (const d of districts) {
        const card = el('div', { class: 'district-card' });
        card.appendChild(el('div', { class: 'district-name' }, t(d.name || '')));
        if (d.description) card.appendChild(el('div', { class: 'district-desc' }, t(d.description)));
        if (d.corpus_source) card.appendChild(el('div', { class: 'district-source' }, t(d.corpus_source)));
        grid.appendChild(card);
      }
      sSection.appendChild(grid);
    }
    frag.appendChild(sSection);

    // ── Characters ──
    const characters = wb.protagonist_archetypes || wb.characters || wb.cast || [];
    if (characters.length > 0) {
      const s = el('div', { class: 'section' });
      s.appendChild(sectionTitle('Characters'));
      const list = el('div', { class: 'entity-list' });
      for (const c of characters) {
        const card = el('div', { class: 'entity-card' });
        const portrait = el('div', { class: 'portrait-canvas' });
        card.appendChild(portrait);
        const body = el('div', { class: 'entity-body' });
        const hdr = el('div', { class: 'entity-header' });
        hdr.appendChild(el('span', { class: 'entity-name' }, t(c.name || c.id || '')));
        if (c.role || c.species) hdr.appendChild(el('span', { class: 'entity-type' }, t(c.role || c.species || '')));
        body.appendChild(hdr);
        if (c.description) body.appendChild(el('div', { class: 'entity-desc' }, t(c.description)));
        const csrc = c.corpus_source || c.source_universe;
        if (csrc) {
          const srcText = typeof csrc === 'string' ? csrc : (csrc.universe || csrc.universe_id || JSON.stringify(csrc));
          body.appendChild(el('div', { class: 'entity-source' }, t(srcText)));
        }
        card.appendChild(body);
        list.appendChild(card);
        renderPortrait(portrait, csrc, c.name || c.id || '');
      }
      s.appendChild(list);
      frag.appendChild(s);
    }

    // ── Factions ──
    const factions = wb.factions || [];
    if (factions.length > 0) {
      const s = el('div', { class: 'section' });
      s.appendChild(sectionTitle('Factions'));
      const list = el('div', { class: 'entity-list' });
      for (const f of factions) {
        const card = el('div', { class: 'entity-card' });
        const portrait = el('div', { class: 'portrait-canvas' });
        card.appendChild(portrait);
        const body = el('div', { class: 'entity-body' });
        const hdr = el('div', { class: 'entity-header' });
        hdr.appendChild(el('span', { class: 'entity-name' }, t(f.name || f.id || '')));
        if (f.type || f.archetype) hdr.appendChild(el('span', { class: 'entity-type' }, t(f.type || f.archetype || '')));
        body.appendChild(hdr);
        if (f.description) body.appendChild(el('div', { class: 'entity-desc' }, t(f.description)));
        const fsrc = f.corpus_source || f.source_universe;
        if (fsrc) {
          const srcText = typeof fsrc === 'string' ? fsrc : (fsrc.universe || fsrc.universe_id || JSON.stringify(fsrc));
          body.appendChild(el('div', { class: 'entity-source' }, t(srcText)));
        }
        card.appendChild(body);
        list.appendChild(card);
        renderPortrait(portrait, fsrc, f.name || f.id || '');
      }
      s.appendChild(list);
      frag.appendChild(s);
    }

    // ── Relationship graph ──
    const relationships = wb.relationship_graph || wb.relationships || [];
    if (relationships.length > 0) {
      const s = el('div', { class: 'section' });
      s.appendChild(sectionTitle('Relationships'));
      const list = el('div', { class: 'rel-list' });
      for (const r of relationships) {
        const row = el('div', { class: 'rel-row' });
        row.appendChild(el('span', { class: 'rel-from' }, t(r.from || r.source || '')));
        row.appendChild(el('span', { class: 'rel-type' }, t(r.type || r.relationship || '→')));
        row.appendChild(el('span', { class: 'rel-to' }, t(r.to || r.target || '')));
        list.appendChild(row);
      }
      s.appendChild(list);
      frag.appendChild(s);
    }

    // ── Visual language ──
    const visual = wb.visual_language;
    if (visual) {
      const desc = typeof visual === 'string' ? visual : visual.description;
      if (desc) {
        const s = el('div', { class: 'section' });
        s.appendChild(sectionTitle('Visual Language'));
        s.appendChild(el('p', { class: 'visual-block' }, t(desc)));
        frag.appendChild(s);
      }
    }

    // ── Share strip ──
    const strip = el('div', { class: 'share-strip' });
    const urlEl = el('div', { class: 'share-url' });
    urlEl.textContent = window.location.href;
    strip.appendChild(urlEl);

    const copyBtn = el('button', { class: 'copy-btn' }, t('Copy link'));
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(window.location.href).then(() => {
        copyBtn.textContent = 'Copied!';
        setTimeout(() => { copyBtn.textContent = 'Copy link'; }, 2000);
      });
    });
    strip.appendChild(copyBtn);
    frag.appendChild(strip);

    return frag;
  }

  // ── Portrait renderer ─────────────────────────────────────────────────────

  // FNV-1a 32-bit hash for deterministic trait selection from entity name
  function simpleHash(str) {
    let h = 2166136261;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = (h * 16777619) >>> 0;
    }
    return h;
  }

  // Decode Nouns RLE image data into pixel rows
  function decodeRLE(data) {
    // data: "0x<bound><colorIdx><runLen>..." each group is 2 hex chars per byte
    const hex = data.startsWith('0x') ? data.slice(2) : data;
    const pixels = [];
    for (let i = 2; i < hex.length; i += 4) {  // skip bounds byte (first byte)
      const colorIdx = parseInt(hex.slice(i, i + 2), 16);
      const run = parseInt(hex.slice(i + 2, i + 4), 16);
      for (let j = 0; j < run; j++) pixels.push(colorIdx);
    }
    return pixels;
  }

  // Build a 32x32 Nouns SVG from image-data for a single part
  function buildNounsSVG(partPixels, palette, offsetX, offsetY) {
    const rects = [];
    for (let i = 0; i < partPixels.length; i++) {
      const cidx = partPixels[i];
      if (cidx === 0) continue; // transparent
      const color = '#' + (palette[cidx] || '000000');
      const x = (i % 32) + offsetX;
      const y = Math.floor(i / 32) + offsetY;
      rects.push(`<rect x="${x}" y="${y}" width="1" height="1" fill="${color}"/>`);
    }
    return rects.join('');
  }

  let _cdnManifest = null;
  async function loadCDNImages(project) {
    if (!_cdnManifest) {
      const resp = await fetch('/static/collection-images.json');
      _cdnManifest = await resp.json();
    }
    return _cdnManifest[project] || [];
  }

  let _nounsCache = null;
  async function fetchNounsData() {
    if (_nounsCache) return _nounsCache;
    try {
      const r = await fetch('/static/nouns/image-data.json');
      _nounsCache = await r.json();
    } catch (e) {
      _nounsCache = null;
    }
    return _nounsCache;
  }

  // Build a complete Nouns portrait SVG string (48x48 viewBox over 32x32 grid)
  async function buildNounsPortrait(seed) {
    const nd = await fetchNounsData();
    if (!nd) return null;
    const h = simpleHash(seed);
    const pal = nd.palette;
    const imgs = nd.images;
    const bgColor = nd.bgcolors ? nd.bgcolors[h % nd.bgcolors.length] : 'd5d7e1';
    const body = imgs.bodies[h % imgs.bodies.length];
    const acc = imgs.accessories[(h >> 4) % imgs.accessories.length];
    const head = imgs.heads[(h >> 8) % imgs.heads.length];
    const glasses = imgs.glasses[(h >> 12) % imgs.glasses.length];
    const parts = [
      buildNounsSVG(decodeRLE(body.data), pal, 0, 0),
      buildNounsSVG(decodeRLE(acc.data), pal, 0, 0),
      buildNounsSVG(decodeRLE(head.data), pal, 0, 0),
      buildNounsSVG(decodeRLE(glasses.data), pal, 0, 0),
    ];
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" shape-rendering="crispEdges">`
      + `<rect width="32" height="32" fill="#${bgColor}"/>`
      + parts.join('')
      + `</svg>`;
  }

  // Mfers: stick-figure with hoodie aesthetic, greyscale + pop color
  function svgMfer(seed) {
    const h = simpleHash(seed);
    const hoodies = ['#2a2a2a','#3d3d3d','#1a1a1a','#4a4040','#3a3a4a'];
    const smokes = ['#e8e8e8','#cccccc','#f0f0f0'];
    const hoodie = hoodies[h % hoodies.length];
    const smoke = smokes[(h >> 4) % smokes.length];
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">`
      + `<rect width="32" height="32" fill="#111"/>`
      + `<ellipse cx="16" cy="9" rx="5" ry="5.5" fill="#d4a574"/>`
      + `<rect x="10" y="14" width="12" height="10" rx="2" fill="${hoodie}"/>`
      + `<rect x="8" y="14" width="4" height="8" rx="1" fill="${hoodie}"/>`
      + `<rect x="20" y="14" width="4" height="8" rx="1" fill="${hoodie}"/>`
      + `<ellipse cx="14" cy="9" rx="1" ry="1" fill="#1a1a1a"/>`
      + `<ellipse cx="18" cy="9" rx="1" ry="1" fill="#1a1a1a"/>`
      + `<line x1="19" y1="10" x2="23" y2="6" stroke="${smoke}" stroke-width="0.8"/>`
      + `<ellipse cx="23" cy="5.5" rx="1.5" ry="1" fill="${smoke}" opacity="0.7"/>`
      + `</svg>`;
  }

  // CrypToadz: load palette from trait-data.json, render pixel-art toad
  let _cryptoadzCache = null;
  async function fetchCryptoadz() {
    if (_cryptoadzCache) return _cryptoadzCache;
    try {
      const r = await fetch('/static/cryptoadz/trait-data.json');
      _cryptoadzCache = await r.json();
    } catch (e) {
      _cryptoadzCache = null;
    }
    return _cryptoadzCache;
  }

  async function buildCryptoadz(seed) {
    const td = await fetchCryptoadz();
    const h = simpleHash(seed);
    // Fall back to hardcoded palette if fetch fails
    const bodyColors = td ? td.body_colors : ['#4a7c3f','#3d6b34','#5a8c4a','#2d5c2a','#6a9c5a'];
    const accentColors = td ? td.accent_colors : ['#ff6600','#ffcc00','#ff3300','#ff9900'];
    const backgrounds = td ? td.backgrounds : ['#1a2a1a','#0d1a0d','#2a3a2a'];
    const neutralDarks = td ? td.neutral_darks : ['#1a2a1a','#2a3a2a'];
    const green = bodyColors[h % bodyColors.length];
    const eye = accentColors[(h >> 6) % accentColors.length];
    const bg = backgrounds[(h >> 10) % backgrounds.length];
    const shadow = neutralDarks[(h >> 14) % neutralDarks.length];
    // Pixel-art toad using rect grid (crispEdges, 32x32)
    // Body: 20x12 block centered; eye bumps: two 8x8 offset; limbs: corner rects
    const rects = [
      // background
      `<rect width="32" height="32" fill="${bg}"/>`,
      // shadow/ground
      `<rect x="6" y="26" width="20" height="4" fill="${shadow}" opacity="0.5"/>`,
      // body
      `<rect x="6" y="14" width="20" height="12" fill="${green}"/>`,
      // belly lighter patch
      `<rect x="10" y="17" width="12" height="7" fill="${green}" opacity="0.7"/>`,
      // left arm
      `<rect x="2" y="18" width="6" height="4" fill="${green}"/>`,
      // right arm
      `<rect x="24" y="18" width="6" height="4" fill="${green}"/>`,
      // left foot
      `<rect x="4" y="24" width="8" height="4" fill="${green}"/>`,
      // right foot
      `<rect x="20" y="24" width="8" height="4" fill="${green}"/>`,
      // left eye bump
      `<rect x="8" y="8" width="8" height="8" fill="${green}"/>`,
      // right eye bump
      `<rect x="16" y="8" width="8" height="8" fill="${green}"/>`,
      // left eye dark
      `<rect x="10" y="10" width="4" height="4" fill="#111"/>`,
      // right eye dark
      `<rect x="18" y="10" width="4" height="4" fill="#111"/>`,
      // left pupil
      `<rect x="11" y="11" width="2" height="2" fill="${eye}"/>`,
      // right pupil
      `<rect x="19" y="11" width="2" height="2" fill="${eye}"/>`,
      // mouth line
      `<rect x="11" y="22" width="10" height="2" fill="${shadow}"/>`,
    ];
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" shape-rendering="crispEdges">`
      + rects.join('')
      + `</svg>`;
  }

  // Bulfinch/Myth: classical marble bust silhouette
  function svgMyth(seed) {
    const h = simpleHash(seed);
    const marbles = ['#e8e4d0','#ddd9c4','#f0ece0','#d4ceba'];
    const accents = ['#c9a84c','#8b7355','#a0522d','#6b8cba'];
    const marble = marbles[h % marbles.length];
    const accent = accents[(h >> 5) % accents.length];
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">`
      + `<rect width="32" height="32" fill="#1a1814"/>`
      + `<ellipse cx="16" cy="11" rx="6" ry="7" fill="${marble}"/>`
      + `<rect x="10" y="17" width="12" height="8" rx="1" fill="${marble}"/>`
      + `<ellipse cx="13" cy="10" rx="1" ry="1.2" fill="#8a7a6a"/>`
      + `<ellipse cx="19" cy="10" rx="1" ry="1.2" fill="#8a7a6a"/>`
      + `<rect x="12" y="13" width="8" height="1" rx="0.5" fill="#9a8a7a"/>`
      + `<rect x="8" y="25" width="16" height="3" rx="0.5" fill="${accent}"/>`
      + `<rect x="9" y="23" width="14" height="2" rx="0" fill="${marble}"/>`
      + `</svg>`;
  }

  // racc00ns: raccoon with mask, stylized
  function svgRacc00ns(seed) {
    const h = simpleHash(seed);
    const furs = ['#7a7a7a','#6a6a6a','#8a8a8a','#5a5a5a','#9a9090'];
    const accents = ['#00ccaa','#0099cc','#cc6600','#9900cc'];
    const fur = furs[h % furs.length];
    const accent = accents[(h >> 7) % accents.length];
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">`
      + `<rect width="32" height="32" fill="#111118"/>`
      + `<ellipse cx="16" cy="14" rx="9" ry="10" fill="${fur}"/>`
      + `<ellipse cx="9" cy="8" rx="3" ry="4" fill="${fur}"/>`
      + `<ellipse cx="23" cy="8" rx="3" ry="4" fill="${fur}"/>`
      + `<ellipse cx="9" cy="8" rx="1.5" ry="2" fill="#222"/>`
      + `<ellipse cx="23" cy="8" rx="1.5" ry="2" fill="#222"/>`
      + `<rect x="9" y="12" width="14" height="4" rx="2" fill="#222" opacity="0.85"/>`
      + `<ellipse cx="13" cy="14" rx="2" ry="2" fill="${accent}" opacity="0.9"/>`
      + `<ellipse cx="19" cy="14" rx="2" ry="2" fill="${accent}" opacity="0.9"/>`
      + `<ellipse cx="16" cy="19" rx="2" ry="1.5" fill="#c8a882"/>`
      + `<ellipse cx="16" cy="20.5" rx="1" ry="0.7" fill="#1a1a1a"/>`
      + `</svg>`;
  }

  // Safe SVG insertion via DOMParser (avoids innerHTML XSS concern)
  function setSVG(container, svgString) {
    const doc = new DOMParser().parseFromString(svgString, 'image/svg+xml');
    const svg = doc.documentElement;
    container.appendChild(svg);
  }

  // Render a CDN image into a portrait container
  async function renderCDNPortrait(container, project, seed) {
    let images;
    try {
      images = await loadCDNImages(project);
    } catch(e) {
      console.error('[portrait] loadCDNImages failed:', project, e);
      return false;
    }
    console.log('[portrait] CDN', project, 'images:', images.length, 'seed:', seed);
    if (!images.length) return false;
    const idx = simpleHash(seed || '') % images.length;
    const { imageUrl } = images[idx];
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = project;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;';
    container.appendChild(img);
    return true;
  }

  // Route portrait generation by corpus source
  async function renderPortrait(container, corpusSource, seed) {
    // corpusSource may be a string like "univ:cryptoadz" or an object like {universe: "univ:cryptoadz"}
    const src = typeof corpusSource === 'string'
      ? corpusSource
      : (corpusSource && (corpusSource.universe || corpusSource.universe_id || JSON.stringify(corpusSource))) || '';
    if (src.includes('nouns')) {
      const svgString = await buildNounsPortrait(seed);
      if (svgString) setSVG(container, svgString);
    } else if (src.includes('mfers')) {
      await renderCDNPortrait(container, 'mfers', seed);
    } else if (src.includes('cryptoadz') || src.includes('toadz')) {
      await renderCDNPortrait(container, 'cryptoadz', seed);
    } else if (src.includes('myth') || src.includes('bulfinch')) {
      const svgString = svgMyth(seed);
      if (svgString) setSVG(container, svgString);
    } else if (src.includes('racc')) {
      await renderCDNPortrait(container, 'racc00ns', seed);
    }
  }

  // ── Section title helper ───────────────────────────────────────────────────

  function sectionTitle(text) {
    return el('div', { class: 'section-title' }, t(text));
  }

  // Render
  const main = document.getElementById('main');
  main.textContent = '';

  if (WORLD && WORLD.refusal) {
    document.title = 'Refusal — CC0 World Generator';
    main.appendChild(renderRefusal(WORLD));
  } else if (WORLD && WORLD.world_bible) {
    document.title = (WORLD.world_bible.title || 'World') + ' — CC0 World Generator';
    main.appendChild(renderWorld(WORLD));
  } else {
    main.appendChild(el('p', { style: 'color: var(--muted);' }, t('World data could not be parsed.')));
  }
</script>
</body>
</html>
